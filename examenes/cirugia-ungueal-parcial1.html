<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Parcial Cirugía Ungueal - Colegio de Podiatría de Monterrey</title>
    <link rel="stylesheet" href="css/examen-base.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="examen-container">
        <div class="examen-wrapper">

            <!-- Pantalla de Inicio -->
            <div id="start-screen" class="pantalla-inicio">
                <img src="https://i.imgur.com/gL0shok.png" alt="Logotipo del Colegio de Podiatría de Monterrey" class="logo-examen">
                <h1 class="titulo-examen">Examen Parcial Cirugía Ungueal</h1>
                <p class="subtitulo-examen">Dra. Antonieta Alejandra Acosta Grajales</p>
                
                <div class="formulario-autenticacion">
                    <div class="grupo-formulario">
                        <label for="studentName">1. Selecciona tu nombre:</label>
                        <select id="studentName" class="campo-entrada" required>
                            <option value="" disabled selected>-- Nombre del Alumno --</option>
                            <!-- ALUMNOS DE PRUEBA (para testing - eliminar después) -->
                            <option value="Prueba 1">Prueba 1</option>
                            <option value="Prueba 2">Prueba 2</option>
                            <option value="Prueba 3">Prueba 3</option>
                            <option value="Prueba 4">Prueba 4</option>
                            <option value="Prueba 5">Prueba 5</option>
                            <option value="Prueba 6">Prueba 6</option>
                            <option value="Prueba 7">Prueba 7</option>
                            <option value="Prueba 8">Prueba 8</option>
                            <option value="Prueba 9">Prueba 9</option>
                            <option value="Prueba 10">Prueba 10</option>
                            <!-- ALUMNOS REALES -->
                            <option value="CESARINA SOLEDAD LOPEZ FERNANDEZ">CESARINA SOLEDAD LOPEZ FERNANDEZ</option>
                            <option value="SOFIA CASTAÑEDA SUAREZ">SOFIA CASTAÑEDA SUAREZ</option>
                            <option value="JESUS MANUEL VEGA LOPEZ">JESUS MANUEL VEGA LOPEZ</option>
                            <option value="EDGAR ALFREDO SANCHEZ LIRA">EDGAR ALFREDO SANCHEZ LIRA</option>
                            <option value="RICARDO ALEJANDRO ROMO GONZALEZ">RICARDO ALEJANDRO ROMO GONZALEZ</option>
                            <option value="KEVIN ANTONIO GUTIERREZ PACHECO">KEVIN ANTONIO GUTIERREZ PACHECO</option>
                            <option value="DIANA LAURA BAÑUELOS REYES">DIANA LAURA BAÑUELOS REYES</option>
                            <option value="GEORGINA VILLALPANDO LÓPEZ">GEORGINA VILLALPANDO LÓPEZ</option>
                            <option value="JAQUELINE GUADALUPE VERA CABRERA">JAQUELINE GUADALUPE VERA CABRERA</option>
                            <option value="MARIA SUSANA HERNANDEZ PAULA">MARIA SUSANA HERNANDEZ PAULA</option>
                            <option value="Dra. Antonieta Alejandra Acosta Grajales">Dra. Antonieta Alejandra Acosta Grajales (Profesora)</option>
                        </select>
                    </div>
                    
                    <div id="student-code-container" class="grupo-formulario hidden">
                        <label for="studentCode">2. Ingresa tu número de matrícula:</label>
                        <input type="number" id="studentCode" class="campo-entrada" placeholder="Número de Matrícula">
                    </div>
                    
                    <div id="student-password-container" class="grupo-formulario hidden">
                        <label for="studentPassword">2. Ingresa tu contraseña:</label>
                        <input type="password" id="studentPassword" class="campo-entrada" placeholder="Contraseña">
                    </div>
                </div>
                
                <div id="status-message" class="mensaje-estado"></div>
                <div id="action-buttons" class="botones-accion"></div>
            </div>

            <!-- Pantalla de Examen -->
            <div id="quiz-screen" class="pantalla-examen hidden">
                <div class="encabezado-examen">
                    <h2 class="numero-pregunta">Pregunta <span id="question-number">1</span> de <span id="total-questions">20</span></h2>
                    <p id="current-section" class="seccion-actual">Embriología</p>
                </div>
                
                <div class="barra-progreso">
                    <div id="progress-bar" class="barra-progreso-interna"></div>
                </div>
                
                <h3 id="question-text" class="texto-pregunta"></h3>
                <div id="options-container" class="contenedor-opciones"></div>
                
                <div class="pie-examen">
                    <button id="next-button" onclick="nextQuestion()" class="btn btn-principal" disabled>Siguiente</button>
                </div>
            </div>

            <!-- Pantalla de Revisión -->
            <div id="review-screen" class="pantalla-revision hidden">
                <h2 class="titulo-revision">Revisión de Respuestas</h2>
                <div id="review-container" class="contenedor-revision"></div>
                <div class="botones-revision">
                    <button onclick="showFinalResult()" class="btn btn-principal">Ver Calificación Final</button>
                </div>
            </div>

            <!-- Pantalla Final -->
            <div id="final-screen" class="pantalla-final hidden">
                <img src="https://i.imgur.com/gL0shok.png" alt="Logotipo del Colegio de Podiatría de Monterrey" class="logo-final">
                <h2 class="titulo-final">Examen Parcial Finalizado</h2>
                <p class="mensaje-final">Hola, <span id="result-name" class="font-bold"></span>. Tu resultado ha sido registrado.</p>
                
                <div id="result-box" class="caja-resultado">
                    <p class="text-2xl font-bold">Tu calificación final es:</p>
                    <p id="score-text" class="calificacion-final"></p>
                    <p id="feedback-text" class="texto-retroalimentacion"></p>
                </div>
                
                <div id="gemini-case-study-container" class="contenedor-caso-estudio">
                    <h3 class="titulo-caso-estudio">✨ Caso de Estudio Personalizado con Fuentes</h3>
                    <div class="botones-caso-estudio">
                        <button id="gemini-case-study-button" onclick="generateCaseStudy()" class="btn btn-oro">Generar Caso de Estudio Personalizado</button>
                    </div>
                    <div id="case-study-content" class="contenido-caso-estudio">
                        <div id="case-study-spinner" class="spinner hidden"></div>
                        <p id="case-study-text" class="texto-caso-estudio"></p>
                        <div id="case-study-sources" class="fuentes-caso-estudio"></div>
                    </div>
                    <div id="case-study-answers-container" class="contenedor-respuestas-caso">
                        <button id="gemini-reveal-answers-button" onclick="revealCaseStudyAnswers()" class="btn btn-oro">✨ Revelar y Explicar Respuestas</button>
                        <div id="case-study-answers-content" class="contenido-respuestas-caso">
                            <div id="case-study-answers-spinner" class="spinner hidden"></div>
                            <p id="case-study-answers-text" class="texto-caso-estudio"></p>
                        </div>
                    </div>
                </div>

                <p class="text-sm text-gray-500 mt-8">Puedes cerrar esta ventana.</p>
            </div>
        </div>
    </div>

    <script src="js/examen-base.js"></script>
    <script>
        // --- CONFIGURACIÓN DEL EXAMEN ---
        const examConfig = {
            examId: 'cirugia_ungueal_parcial1',
            examTitle: 'Examen Parcial Cirugía Ungueal',
            questions: [
                {
                    section: "Embriología",
                    question: "Durante el seguimiento ecográfico de un feto de 5 meses, se observa una estructura queratinizada sobre el lecho ungueal, pero aún no es la uña definitiva. ¿En qué fase del desarrollo ungueal se encuentra y qué evento clave está por suceder?",
                    options: [
                        "A) Fase fibrilar, donde se definirá el pliegue proximal.",
                        "B) Fase escamosa, donde las células de la matriz comenzarán a generar la lámina ungueal verdadera.",
                        "C) Fase granular, donde se diferenciará el hiponiquio.",
                        "D) Fase de placa, donde se formará el surco transversal."
                    ],
                    answer: "B) Fase escamosa, donde las células de la matriz comenzarán a generar la lámina ungueal verdadera.",
                    feedback: "La opción B es la correcta. La 'falsa uña' es la queratinización del lecho. La fase escamosa es crítica porque es cuando la matriz ungueal se activa y comienza a producir la lámina definitiva que reemplazará esta estructura temporal."
                },
                {
                    section: "Embriología",
                    question: "Un neonato es diagnosticado con Síndrome EEC, presentando malformaciones en manos y pies, incluyendo uñas displásicas. Este síndrome se asocia a mutaciones en un gen crucial para la cresta epidérmica apical. ¿Qué gen está implicado?",
                    options: [
                        "A) SHH, responsable de la polaridad del miembro.",
                        "B) WNT7a, implicado en la dorsalización.",
                        "C) p63, esencial para la integridad de la cresta epidérmica apical.",
                        "D) FGF, que regula la proliferación celular."
                    ],
                    answer: "C) p63, esencial para la integridad de la cresta epidérmica apical.",
                    feedback: "La opción C es correcta. El gen p63 es un factor de transcripción maestro para el desarrollo ectodérmico. Su función en la cresta epidérmica apical es indispensable para la correcta formación de las extremidades, incluyendo la piel y sus apéndices como las uñas."
                },
                {
                    section: "Embriología",
                    question: "En un estudio sobre el desarrollo fetal, se observa que alrededor de la semana 17 la uña ya cubre la mayor parte del lecho. ¿Qué evento clave ocurrió aproximadamente en la semana 14 para permitir este crecimiento?",
                    options: [
                        "A) La formación del esbozo de la lámina ungueal.",
                        "B) La constitución definitiva de la matriz ungueal.",
                        "C) La emergencia de la lámina ungueal desde debajo del pliegue proximal.",
                        "D) La queratinización completa del hiponiquio."
                    ],
                    answer: "C) La emergencia de la lámina ungueal desde debajo del pliegue proximal.",
                    feedback: "La opción C es correcta. Siguiendo la cronología del desarrollo, después de que la matriz se forma y comienza a producir la lámina, el evento clave es la emergencia visible de esta lámina, que luego crece distalmente para cubrir el lecho."
                },
                {
                    section: "Embriología",
                    question: "Un investigador estudia la señalización molecular en el desarrollo ungueal. Observa que la vía de Wnt7a es fundamental para el establecimiento del eje dorso-ventral del miembro. ¿Qué consecuencia directa tiene esta vía en la formación de la uña?",
                    options: [
                        "A) Determina el grosor final de la lámina ungueal.",
                        "B) Es necesaria para la formación del lecho ungueal vascularizado.",
                        "C) Induce la formación de la matriz ungueal en la cara dorsal del dedo.",
                        "D) Controla la apoptosis en el pulpejo para dar forma al dedo."
                    ],
                    answer: "C) Induce la formación de la matriz ungueal en la cara dorsal del dedo.",
                    feedback: "La opción C es la correcta. La señalización de Wnt7a en el ectodermo dorsal es el 'interruptor' que le dice a esa región del dedo que debe diferenciarse en estructuras dorsales, como la matriz ungueal, en lugar de en piel plantar."
                },
                {
                    section: "Anatomía",
                    question: "Durante una matricectomía por onicocriptosis, el cirujano debe asegurarse de eliminar por completo las extensiones laterales de la matriz para evitar la recurrencia. ¿Cómo se denominan estas proyecciones y por qué es crucial su extirpación?",
                    options: [
                        "A) Lúnulas laterales; porque producen el color de la uña.",
                        "B) Cuernos de la matriz; porque son tejido germinal que produce los bordes de la uña.",
                        "C) Pliegues periungueales; porque anclan la uña al dedo.",
                        "D) Bandas onicodérmicas; porque sellan el espacio subungueal."
                    ],
                    answer: "B) Cuernos de la matriz; porque son tejido germinal que produce los bordes de la uña.",
                    feedback: "La opción B es la correcta. Los 'cuernos' son las partes más laterales de la matriz productora de uña. Si se deja algún resto, seguirá generando una espícula de uña que causará la recurrencia de la onicocriptosis."
                },
                {
                    section: "Anatomía",
                    question: "Al realizar una biopsia de la matriz ungueal, se debe tener cuidado de no profundizar excesivamente para no dañar una estructura tendinosa importante que se inserta cerca de su base. ¿A qué tendón nos referimos?",
                    options: [
                        "A) Tendón del flexor largo del hallux.",
                        "B) Tendón del extensor largo de los dedos.",
                        "C) Tendón del tibial anterior.",
                        "D) Tendón de Aquiles."
                    ],
                    answer: "B) Tendón del extensor largo de los dedos.",
                    feedback: "La opción B es la correcta. Las fibras del tendón extensor se insertan en la falange distal, muy cerca de la base de la matriz ungueal. Una biopsia o cirugía demasiado agresiva en esta zona podría lesionarlo."
                },
                {
                    section: "Anatomía",
                    question: "Un paciente sufre un traumatismo por aplastamiento en el primer ortejo. Para evaluar la viabilidad del aparato ungueal, es crucial entender su irrigación. ¿Cuál de las siguientes opciones describe correctamente la vascularización de la matriz y el lecho?",
                    options: [
                        "A) Una única arteria digital que se ramifica en el pulpejo.",
                        "B) Una arcada proximal para la matriz y una arcada distal para el lecho ungueal.",
                        "C) Irrigación directa desde los vasos de la falange distal.",
                        "D) Un plexo venoso superficial sin un componente arterial definido."
                    ],
                    answer: "B) Una arcada proximal para la matriz y una arcada distal para el lecho ungueal.",
                    feedback: "La opción B describe correctamente la anatomía vascular. Las arterias digitales forman dos arcadas anastomóticas: una proximal que irriga la matriz (vital para el crecimiento) y una distal para el lecho y el hiponiquio."
                },
                {
                    section: "Anatomía",
                    question: "Un paciente presenta una pigmentación oscura (melanoniquia) en la uña. Para realizar una biopsia y determinar si hay atipia, se debe tomar muestra del tejido donde residen los melanocitos. ¿En qué estructura del aparato ungueal se encuentran principalmente estas células?",
                    options: [
                        "A) En el eponiquio (cutícula).",
                        "B) En el lecho ungueal, de forma difusa.",
                        "C) En la matriz ungueal.",
                        "D) En el hiponiquio."
                    ],
                    answer: "C) En la matriz ungueal.",
                    feedback: "La opción C es la correcta. La matriz es donde se encuentran los melanocitos que producen el pigmento (melanina) y lo transfieren a las células de la uña (onicocitos) a medida que esta se forma. Por eso, una biopsia por melanoniquia debe incluir tejido matricial."
                },
                {
                    section: "Patología Ungueal",
                    question: "Un paciente con psoriasis severa acude a consulta por presentar múltiples depresiones puntiformes en sus uñas, similar a un 'dedal'. ¿Qué proceso fisiopatológico en la matriz ungueal explica la formación de este 'pitting'?",
                    options: [
                        "A) Una inflamación crónica que causa adelgazamiento general de la uña.",
                        "B) Focos de queratinización anormal (paraqueratosis) en la matriz proximal que se desprenden.",
                        "C) Ruptura de pequeños capilares en el lecho, formando hemorragias.",
                        "D) Hiperproliferación de la matriz que resulta en un engrosamiento irregular."
                    ],
                    answer: "B) Focos de queratinización anormal (paraqueratosis) en la matriz proximal que se desprenden.",
                    feedback: "La opción B es correcta. El pitting psoriásico ocurre cuando pequeños focos de células en la matriz proximal queratinizan de forma defectuosa. Estas células paraqueratósicas no se compactan bien y se desprenden de la superficie de la uña a medida que crece, dejando las depresiones."
                },
                {
                    section: "Patología Ungueal",
                    question: "Un paciente de 65 años, fumador, presenta una onicolisis (separación de la uña del lecho) en un solo dedo que no responde a tratamientos para hongos ni mejora con cuidados generales. La lesión progresa lentamente y presenta hiperqueratosis subungueal. ¿Qué patología grave se debe sospechar?",
                    options: [
                        "A) Verruga subungueal.",
                        "B) Exostosis subungueal.",
                        "C) Carcinoma escamoso subungueal.",
                        "D) Psoriasis ungueal localizada."
                    ],
                    answer: "C) Carcinoma escamoso subungueal.",
                    feedback: "La opción C es correcta. Una onicolisis crónica, unilateral y que no responde a tratamientos convencionales, especialmente en un paciente mayor con factores de riesgo, debe hacer levantar una alta sospecha de carcinoma escamoso subungueal."
                },
                {
                    section: "Patología Ungueal",
                    question: "Una paciente presenta una banda roja longitudinal (eritroniquia) en el segundo dedo, con una fisura distal en 'V' e hiperqueratosis. La dermatoscopia no muestra vasos atípicos. ¿Cuál es el tumor benigno más frecuentemente asociado a esta tríada clínica?",
                    options: [
                        "A) Tumor glómico.",
                        "B) Onicopapiloma.",
                        "C) Fibroqueratoma.",
                        "D) Quiste mixoide."
                    ],
                    answer: "B) Onicopapiloma.",
                    feedback: "La opción B es la correcta. La combinación de eritroniquia, fisura distal e hiperqueratosis subungueal es altamente específica para el onicopapiloma, un tumor benigno del epitelio de la matriz distal y el lecho ungueal."
                },
                {
                    section: "Patología Ungueal",
                    question: "Un paciente llega a urgencias tras un traumatismo severo en el dedo, presentando un desprendimiento completo de la lámina ungueal desde su base (onicomadesis). ¿Qué grado de afectación de la matriz implica este signo clínico?",
                    options: [
                        "A) Una afectación leve y transitoria de la matriz proximal.",
                        "B) Una injuria severa que causó una detención completa y temporal de la función de toda la matriz.",
                        "C) Un daño exclusivo del lecho ungueal, sin compromiso de la matriz.",
                        "D) Una alteración crónica de la matriz distal."
                    ],
                    answer: "B) Una injuria severa que causó una detención completa y temporal de la función de toda la matriz.",
                    feedback: "La opción B es la correcta. La onicomadesis es la expresión máxima de una detención de la actividad matricial. La injuria (traumática, infecciosa, sistémica) fue lo suficientemente severa como para que la matriz dejara de producir uña por completo, causando una fractura transversal en toda la lámina."
                },
                {
                    section: "Patología Ungueal",
                    question: "Un paciente de fototipo II (piel clara) presenta una única banda de pigmento oscuro, de 4 mm de ancho, en el hallux, con variación de color y pigmentación del pliegue proximal (signo de Hutchinson). ¿Cuál es el diagnóstico más probable y la acción a seguir?",
                    options: [
                        "A) Hematoma subungueal; observar evolución.",
                        "B) Nevo de la unión; control fotográfico anual.",
                        "C) Melanoma subungueal; requiere biopsia urgente.",
                        "D) Activación melanocítica benigna; tranquilizar al paciente."
                    ],
                    answer: "C) Melanoma subungueal; requiere biopsia urgente.",
                    feedback: "La opción C es la correcta. La presencia de una banda pigmentada única, ancha, con varios colores y, sobre todo, el signo de Hutchinson en un paciente de piel clara, son todos signos de alta sospecha de melanoma. La biopsia de la matriz es mandatoria."
                },
                {
                    section: "Patología Ungueal",
                    question: "Una madre te consulta por las 'manchitas blancas' en las uñas de su hijo, preocupada por una deficiencia de calcio. ¿Cuál es la explicación fisiopatológica correcta para esta leuconiquia punctata?",
                    options: [
                        "A) Son burbujas de aire atrapadas en la lámina.",
                        "B) Es un signo de deficiencia de zinc.",
                        "C) Son focos de queratinización defectuosa (paraqueratosis) en la matriz por microtraumas.",
                        "D) Indican una infección fúngica superficial."
                    ],
                    answer: "C) Son focos de queratinización defectuosa (paraqueratosis) en la matriz por microtraumas.",
                    feedback: "La opción C es la más precisa. La leuconiquia punctata no se debe a falta de calcio ni a burbujas de aire (mitos comunes). Se produce por microtraumatismos en la matriz que alteran la queratinización, dejando células con núcleo (paraqueratósicas) que se ven blancas."
                },
                {
                    section: "Técnicas Anestésicas",
                    question: "Vas a realizar una matricectomía en el hallux. Para asegurar una anestesia completa con un bloqueo digital proximal, recuerdas que los nervios en este dedo tienen una disposición más plantar. ¿Qué maniobra es indispensable en tu técnica?",
                    options: [
                        "A) Usar un mayor volumen de anestésico que en otros dedos.",
                        "B) Inyectar solo en el dorso para evitar la arteria plantar.",
                        "C) Infiltrar profundo hasta la cara plantar y luego bloquear las ramas dorsales bajo el tendón extensor.",
                        "D) Realizar la punción a nivel de la articulación interfalángica."
                    ],
                    answer: "C) Infiltrar profundo hasta la cara plantar y luego bloquear las ramas dorsales bajo el tendón extensor.",
                    feedback: "La opción C describe la técnica correcta. Es crucial asegurar que el anestésico llegue a la cara plantar y luego bloquear las ramas dorsales para lograr una anestesia completa y exitosa del hallux."
                },
                {
                    section: "Técnicas Anestésicas",
                    question: "Un niño llega a urgencias con un hematoma subungueal a tensión muy doloroso que requiere drenaje inmediato. Para minimizar el dolor y el tiempo, ¿cuál es la técnica anestésica de elección por su rapidez de acción?",
                    options: [
                        "A) Bloqueo del nervio tibial posterior.",
                        "B) Bloqueo digital proximal.",
                        "C) Bloqueo digital distal (infiltración de los pliegues periungueales).",
                        "D) Anestesia tópica con cloruro de etilo."
                    ],
                    answer: "C) Bloqueo digital distal (infiltración de los pliegues periungueales).",
                    feedback: "La opción C es la ideal. El bloqueo distal actúa sobre las terminaciones nerviosas de forma casi instantánea, proporcionando una anestesia rápida y efectiva para procedimientos urgentes y localizados en la uña."
                },
                {
                    section: "Técnicas Anestésicas",
                    question: "Estás realizando una biopsia de matriz y realizas una inyección submatricial. Inyectas lentamente el anestésico y observas que la zona de la lúnula se vuelve pálida. ¿Qué significa este signo clínico?",
                    options: [
                        "A) Que has inyectado en la articulación.",
                        "B) Que la infiltración es correcta, ya que el líquido comprime los capilares.",
                        "C) Que estás causando una reacción alérgica local.",
                        "D) Que has puncionado la falange distal."
                    ],
                    answer: "B) Que la infiltración es correcta, ya que el líquido comprime los capilares.",
                    feedback: "La opción B es la correcta. La palidez isquémica en la lúnula es el signo visual de que el anestésico está en el plano correcto, entre la matriz y el hueso, asegurando una anestesia efectiva para el procedimiento."
                },
                {
                    section: "Técnicas Anestésicas",
                    question: "Un paciente requiere el desbridamiento de lesiones ulcerosas en la cara plantar de los cinco dedos del pie. Para maximizar la comodidad del paciente y la eficiencia del procedimiento, ¿qué bloqueo nervioso único sería el más apropiado?",
                    options: [
                        "A) Bloqueo del nervio safeno.",
                        "B) Cinco bloqueos digitales proximales individuales.",
                        "C) Bloqueo del nervio tibial posterior a nivel del tobillo.",
                        "D) Bloqueo del nervio peroneo superficial."
                    ],
                    answer: "C) Bloqueo del nervio tibial posterior a nivel del tobillo.",
                    feedback: "La opción C es la más eficiente. El nervio tibial posterior inerva la mayor parte de la planta del pie. Un solo bloqueo en el túnel del tarso puede anestesiar toda la zona, evitando múltiples y dolorosas inyecciones."
                },
                {
                    section: "Técnicas Anestésicas",
                    question: "Durante un bloqueo digital, aspiras antes de inyectar y obtienes sangre en la jeringa, indicando una punción intravascular. Además del hematoma, ¿cuál es el riesgo sistémico más grave si inyectaras el anestésico?",
                    options: [
                        "A) Necrosis del dedo.",
                        "B) Una infección severa.",
                        "C) Toxicidad cardiovascular o del sistema nervioso central.",
                        "D) Falla del bloqueo anestésico."
                    ],
                    answer: "C) Toxicidad cardiovascular o del sistema nervioso central.",
                    feedback: "La opción C es correcta. La inyección intravascular de un anestésico local puede causar toxicidad sistémica, con efectos graves como arritmias cardíacas o convulsiones. Por eso la aspiración es un paso de seguridad fundamental."
                },
                {
                    section: "Técnicas Anestésicas",
                    question: "Te preparas para una matricectomía química con fenol en un paciente con onicocriptosis. Después de la avulsión parcial y la exéresis del tejido de granulación, aplicas un torniquete y esperas a que el campo esté exangüe. ¿Por qué es este paso tan crucial para el éxito del procedimiento?",
                    options: [
                        "A) Para disminuir la inflamación postoperatoria.",
                        "B) Para prevenir que la sangre inactive el fenol, lo que causaría un fallo en la cauterización.",
                        "C) Para asegurar que el anestésico local siga haciendo efecto.",
                        "D) Para reducir el riesgo de infección post-quirúrgica."
                    ],
                    answer: "B) Para prevenir que la sangre inactive el fenol, lo que causaría un fallo en la cauterización.",
                    feedback: "La opción B es la correcta. El fenol actúa coagulando las proteínas del tejido. La sangre es rica en proteínas, y si está presente, neutralizará el fenol antes de que pueda destruir eficazmente la matriz, llevando a una alta probabilidad de recurrencia."
                }
            ]
        };

        // --- FUNCIONES PARA CASO DE ESTUDIO CON GEMINI ---
        const GEMINI_API_KEY = "AIzaSyCdkq5Bjzp4fpyMndVKp2CZx5Be_WkEv5I"; // API key de Gemini

        async function callGroundedGemini(prompt, systemPrompt) {
            const model = "gemini-2.5-pro"; // Modelo más reciente y potente - Gemini 2.5 Pro
            if (!GEMINI_API_KEY) {
                return {
                    text: "Error: La clave de la API de Gemini no ha sido configurada. Por favor, añádela en la variable 'GEMINI_API_KEY' dentro del código.",
                    sources: []
                };
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
            };

            if (systemPrompt) {
                payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate?.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const groundingMetadata = candidate.groundingMetadata;
                    const sources = (groundingMetadata?.groundingAttributions || []).map(attr => ({
                        uri: attr.web?.uri,
                        title: attr.web?.title
                    })).filter(s => s.uri && s.title);
                    return { text, sources };
                } else {
                    console.warn("API response structure might have changed or was empty:", result);
                    let errorMessage = "No se recibió una respuesta válida de la API.";
                    if (candidate && candidate.finishReason === 'SAFETY') {
                        errorMessage = "La respuesta fue bloqueada por políticas de seguridad. Intenta reformular la solicitud.";
                    }
                    return { text: errorMessage, sources: [] };
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return {
                    text: "Lo siento, no se pudo generar la respuesta en este momento. Por favor, revisa la consola para más detalles.",
                    sources: []
                };
            }
        }

        async function generateCaseStudy() {
            const button = document.getElementById('gemini-case-study-button');
            const spinner = document.getElementById('case-study-spinner');
            const textEl = document.getElementById('case-study-text');
            const sourcesEl = document.getElementById('case-study-sources');
            const answersContainer = document.getElementById('case-study-answers-container');

            button.disabled = true;
            spinner.classList.remove('hidden');
            textEl.textContent = '';
            sourcesEl.innerHTML = '';
            answersContainer.classList.add('hidden');
            document.getElementById('case-study-answers-content').classList.add('hidden');

            // Determinar si hay errores o si es 100%
            const incorrectTopics = new Set();
            const allTopics = new Set();
            
            examen.userAnswers.forEach((answer, index) => {
                const question = examen.config.questions[index];
                allTopics.add(question.section);
                
                if (question.options[answer] !== question.answer) {
                    incorrectTopics.add(question.section);
                }
            });

            let topics, userPrompt;
            
            if (incorrectTopics.size > 0) {
                // Hay errores: caso personalizado basado en temas fallidos
                topics = Array.from(incorrectTopics).join(', ');
                userPrompt = `Temas a reforzar: ${topics}. Por favor, genera el caso de estudio.`;
            } else {
                // Es 100%: caso clínico de tema aleatorio
                const randomTopics = Array.from(allTopics);
                const randomTopic = randomTopics[Math.floor(Math.random() * randomTopics.length)];
                topics = randomTopic;
                userPrompt = `El estudiante obtuvo 100% en el examen. Genera un caso clínico avanzado sobre: ${randomTopic}. Debe ser más desafiante que las preguntas del examen.`;
            }

            const systemPrompt = `Eres un profesor experto en podiatría creando un caso clínico para un estudiante. Basado en los siguientes temas, crea un caso práctico y conciso (150-200 palabras) que presente un escenario de un paciente realista. 

Basate específicamente en estas fuentes académicas de podiatría:

LIBROS DE TEXTO CLÁSICOS:
- McGlamry's Comprehensive Textbook of Foot and Ankle Surgery
- The Foot and Ankle: A Core Curriculum (Coughlin, Mann, Saltzman)
- Surgery of the Foot and Ankle (Coughlin, Mann, Saltzman)
- Podiatric Medicine and Surgery (Banks, Downey, Martin)
- Nail Surgery (Nail Surgery Atlas - Haneke)
- Dermatology - Bolognia (secciones de uñas)

REVISTAS ACADÉMICAS:
- Journal of the American Podiatric Medical Association (JAPMA)
- Foot & Ankle International
- Journal of Foot and Ankle Surgery
- Dermatologic Surgery (secciones de cirugía ungueal)
- International Journal of Dermatology
- Journal of the European Academy of Dermatology and Venereology

Finaliza con 1-2 preguntas desafiantes para que el estudiante reflexione sobre diagnóstico diferencial, técnica quirúrgica, o manejo postoperatorio.`;

            const result = await callGroundedGemini(userPrompt, systemPrompt);
            
            const fullText = result.text;
            const questionRegex = /(Pregunta[s]? \d+[:.].*|\¿.*?\?)/gi;
            const questions = fullText.match(questionRegex);
            
            examen.caseStudyCache = {
                text: fullText,
                sources: result.sources,
                questions: questions ? questions.join('\n') : ''
            };
            
            textEl.textContent = fullText;
            
            if (result.sources && result.sources.length > 0) {
                let sourcesHtml = '<h4 class="titulo-fuentes">Fuentes Consultadas:</h4><ul class="lista-fuentes">';
                result.sources.forEach(source => {
                    sourcesHtml += `<li><a href="${source.uri}" target="_blank">${source.title}</a></li>`;
                });
                sourcesHtml += '</ul>';
                sourcesEl.innerHTML = sourcesHtml;
            }

            spinner.classList.add('hidden');
            
            if (examen.caseStudyCache.questions) {
                answersContainer.classList.remove('hidden');
                document.getElementById('gemini-reveal-answers-button').disabled = false;
                document.getElementById('case-study-answers-content').classList.add('hidden');
            }
        }

        async function revealCaseStudyAnswers() {
            const button = document.getElementById('gemini-reveal-answers-button');
            const answersContent = document.getElementById('case-study-answers-content');
            const spinner = document.getElementById('case-study-answers-spinner');
            const textEl = document.getElementById('case-study-answers-text');

            button.disabled = true;
            answersContent.classList.remove('hidden');
            spinner.classList.remove('hidden');
            textEl.textContent = '';

            const systemPrompt = "Eres un profesor experto en podiatría. Responde de forma clara y fundamentada las siguientes preguntas, basándote en el caso clínico proporcionado. Explica el razonamiento clínico detrás de cada respuesta.";
            const userPrompt = `
                Basado en el siguiente caso clínico:
                ---
                ${examen.caseStudyCache.text}
                ---
                Responde y explica las siguientes preguntas:
                ${examen.caseStudyCache.questions}
            `;
            
            const result = await callGroundedGemini(userPrompt, systemPrompt);
            textEl.textContent = result.text;
            
            spinner.classList.add('hidden');
        }
    </script>
</body>
</html>
