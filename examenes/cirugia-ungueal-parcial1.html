<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen Parcial Cirug√≠a Ungueal - Colegio de Podiatr√≠a de Monterrey</title>
    <link rel="stylesheet" href="css/examen-base.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* Estilos espec√≠ficos para m√≥viles */
        @media (max-width: 768px) {
            .campo-entrada {
                font-size: 16px !important; /* Previene zoom en iOS */
                padding: 12px 16px !important;
                min-height: 48px !important; /* Tama√±o m√≠nimo t√°ctil */
                border-radius: 8px !important;
                border: 2px solid #e5e7eb !important;
                background-color: #ffffff !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            
            select.campo-entrada {
                appearance: none !important;
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
                background-repeat: no-repeat !important;
                background-position: right 12px center !important;
                background-size: 20px !important;
                padding-right: 40px !important;
            }
            
            .grupo-formulario {
                margin-bottom: 20px !important;
            }
            
            .grupo-formulario label {
                display: block !important;
                margin-bottom: 8px !important;
                font-weight: 600 !important;
                color: #374151 !important;
                font-size: 14px !important;
            }
            
            /* Mejorar la visibilidad del formulario en m√≥viles */
            .formulario-autenticacion {
                padding: 20px !important;
                background: #f9fafb !important;
                border-radius: 12px !important;
                margin: 20px 0 !important;
            }
            
            /* Estilos para fuentes acad√©micas */
            .separador-fuentes {
                border: none;
                height: 2px;
                background: linear-gradient(to right, #c5a473, #013b56);
                margin: 20px 0;
                border-radius: 1px;
            }
            
            .titulo-fuentes {
                color: #013b56;
                font-size: 1.1rem;
                font-weight: 700;
                margin: 15px 0 10px 0;
                display: flex;
                align-items: center;
                gap: 8px;
            }
        }
        
        /* Estilos adicionales para pantallas muy peque√±as */
        @media (max-width: 480px) {
            .campo-entrada {
                font-size: 16px !important;
                padding: 14px 16px !important;
                min-height: 52px !important;
            }
            
            .formulario-autenticacion {
                margin: 10px !important;
                padding: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="examen-container">
        <div class="examen-wrapper">

            <!-- Pantalla de Inicio -->
            <div id="start-screen" class="pantalla-inicio">
                <img src="https://i.imgur.com/gL0shok.png" alt="Logotipo del Colegio de Podiatr√≠a de Monterrey" class="logo-examen">
                <h1 class="titulo-examen">Examen Parcial Cirug√≠a Ungueal</h1>
                <p class="subtitulo-examen">Dra. Antonieta Alejandra Acosta Grajales</p>
                
                <div class="formulario-autenticacion">
                    <div class="grupo-formulario">
                        <label for="studentName">1. Selecciona tu nombre:</label>
                        <select id="studentName" class="campo-entrada" required autocomplete="off">
                            <option value="" disabled selected>-- Nombre del Alumno --</option>
                            <!-- ALUMNOS REALES -->
                            <option value="CESARINA SOLEDAD LOPEZ FERNANDEZ">CESARINA SOLEDAD LOPEZ FERNANDEZ</option>
                            <option value="SOFIA CASTA√ëEDA SUAREZ">SOFIA CASTA√ëEDA SUAREZ</option>
                            <option value="JESUS MANUEL VEGA LOPEZ">JESUS MANUEL VEGA LOPEZ</option>
                            <option value="EDGAR ALFREDO SANCHEZ LIRA">EDGAR ALFREDO SANCHEZ LIRA</option>
                            <option value="RICARDO ALEJANDRO ROMO GONZALEZ">RICARDO ALEJANDRO ROMO GONZALEZ</option>
                            <option value="KEVIN ANTONIO GUTIERREZ PACHECO">KEVIN ANTONIO GUTIERREZ PACHECO</option>
                            <option value="DIANA LAURA BA√ëUELOS REYES">DIANA LAURA BA√ëUELOS REYES</option>
                            <option value="GEORGINA VILLALPANDO L√ìPEZ">GEORGINA VILLALPANDO L√ìPEZ</option>
                            <option value="JAQUELINE GUADALUPE VERA CABRERA">JAQUELINE GUADALUPE VERA CABRERA</option>
                            <option value="MARIA SUSANA HERNANDEZ PAULA">MARIA SUSANA HERNANDEZ PAULA</option>
                            <option value="Dra. Antonieta Alejandra Acosta Grajales">Dra. Antonieta Alejandra Acosta Grajales (Profesora)</option>
                        </select>
                    </div>
                    
                    <div id="student-code-container" class="grupo-formulario hidden">
                        <label for="studentCode">2. Ingresa tu n√∫mero de matr√≠cula:</label>
                        <input type="number" id="studentCode" class="campo-entrada" placeholder="N√∫mero de Matr√≠cula">
                    </div>
                    
                    <div id="student-password-container" class="grupo-formulario hidden">
                        <label for="studentPassword">2. Ingresa tu contrase√±a:</label>
                        <input type="password" id="studentPassword" class="campo-entrada" placeholder="Contrase√±a">
                    </div>
                </div>
                
                <div id="status-message" class="mensaje-estado"></div>
                <div id="loading-indicator" class="loading-indicator hidden">
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Cargando examen...</p>
                </div>
                <div id="action-buttons" class="botones-accion"></div>
            </div>

            <!-- Pantalla de Examen -->
            <div id="quiz-screen" class="pantalla-examen hidden">
                <div class="encabezado-examen">
                    <h2 class="numero-pregunta">Pregunta <span id="question-number">1</span> de <span id="total-questions">20</span></h2>
                    <p id="current-section" class="seccion-actual">Embriolog√≠a</p>
                </div>
                
                <div class="barra-progreso">
                    <div id="progress-bar" class="barra-progreso-interna"></div>
                </div>
                
                <h3 id="question-text" class="texto-pregunta"></h3>
                <div id="options-container" class="contenedor-opciones"></div>
                
                <div class="pie-examen">
                    <button id="next-button" onclick="nextQuestion()" class="btn btn-principal" disabled>Siguiente</button>
                </div>
            </div>

            <!-- Pantalla de Revisi√≥n -->
            <div id="review-screen" class="pantalla-revision hidden">
                <h2 class="titulo-revision">Revisi√≥n de Respuestas</h2>
                <div id="review-container" class="contenedor-revision"></div>
                <div class="botones-revision">
                    <button onclick="showFinalResult()" class="btn btn-principal">Ver Calificaci√≥n Final</button>
                </div>
            </div>

            <!-- Pantalla Final -->
            <div id="final-screen" class="pantalla-final hidden">
                <img src="https://i.imgur.com/gL0shok.png" alt="Logotipo del Colegio de Podiatr√≠a de Monterrey" class="logo-final">
                <h2 class="titulo-final">Examen Parcial Finalizado</h2>
                <p class="mensaje-final">Hola, <span id="result-name" class="font-bold"></span>. Tu resultado ha sido registrado.</p>
                
                <div id="result-box" class="caja-resultado">
                    <p class="text-2xl font-bold">Tu calificaci√≥n final es:</p>
                    <p id="score-text" class="calificacion-final"></p>
                    <p id="feedback-text" class="texto-retroalimentacion"></p>
                </div>
                
                <div id="gemini-case-study-container" class="contenedor-caso-estudio">
                    <h3 class="titulo-caso-estudio">‚ú® Caso de Estudio Personalizado</h3>
                    <div class="botones-caso-estudio">
                        <button id="gemini-case-study-button" onclick="generateCaseStudy()" class="btn btn-oro">Generar Caso de Estudio Personalizado</button>
                    </div>
                    <div id="case-study-content" class="contenido-caso-estudio">
                        <div id="case-study-spinner" class="spinner hidden"></div>
                        <p id="case-study-text" class="texto-caso-estudio"></p>
                        <div id="case-study-sources" class="fuentes-caso-estudio"></div>
                    </div>
                    <div id="case-study-answers-container" class="contenedor-respuestas-caso">
                        <button id="gemini-reveal-answers-button" onclick="revealCaseStudyAnswers()" class="btn btn-oro">‚ú® Analizar Caso Cl√≠nico y Responder Preguntas</button>
                        <div id="case-study-answers-content" class="contenido-respuestas-caso">
                            <div id="case-study-answers-spinner" class="spinner hidden"></div>
                            <p id="case-study-answers-text" class="texto-caso-estudio"></p>
                        </div>
                    </div>
                </div>

                <p class="text-sm text-gray-500 mt-8">Puedes cerrar esta ventana.</p>
            </div>
        </div>
    </div>

    <script src="js/examen-base.js"></script>
    <script>
        // --- CONFIGURACI√ìN DEL EXAMEN ---
        const examConfig = {
            examId: 'cirugia_ungueal_parcial1',
            examTitle: 'Examen Parcial Cirug√≠a Ungueal',
            questions: [
                {
                    section: "Embriolog√≠a",
                    question: "Durante el seguimiento ecogr√°fico de un feto de 5 meses, se observa una estructura queratinizada sobre el lecho ungueal, pero a√∫n no es la u√±a definitiva. ¬øEn qu√© fase del desarrollo ungueal se encuentra y qu√© evento clave est√° por suceder?",
                    options: [
                        "A) Fase fibrilar, donde se definir√° el pliegue proximal.",
                        "B) Fase escamosa, donde las c√©lulas de la matriz comenzar√°n a generar la l√°mina ungueal verdadera.",
                        "C) Fase granular, donde se diferenciar√° el hiponiquio.",
                        "D) Fase de placa, donde se formar√° el surco transversal."
                    ],
                    answer: "B) Fase escamosa, donde las c√©lulas de la matriz comenzar√°n a generar la l√°mina ungueal verdadera.",
                    feedback: "La opci√≥n B es la correcta. La 'falsa u√±a' es la queratinizaci√≥n del lecho. La fase escamosa es cr√≠tica porque es cuando la matriz ungueal se activa y comienza a producir la l√°mina definitiva que reemplazar√° esta estructura temporal."
                },
                {
                    section: "Embriolog√≠a",
                    question: "Un neonato es diagnosticado con S√≠ndrome EEC, presentando malformaciones en manos y pies, incluyendo u√±as displ√°sicas. Este s√≠ndrome se asocia a mutaciones en un gen crucial para la cresta epid√©rmica apical. ¬øQu√© gen est√° implicado?",
                    options: [
                        "A) SHH, responsable de la polaridad del miembro.",
                        "B) WNT7a, implicado en la dorsalizaci√≥n.",
                        "C) p63, esencial para la integridad de la cresta epid√©rmica apical.",
                        "D) FGF, que regula la proliferaci√≥n celular."
                    ],
                    answer: "C) p63, esencial para la integridad de la cresta epid√©rmica apical.",
                    feedback: "La opci√≥n C es correcta. El gen p63 es un factor de transcripci√≥n maestro para el desarrollo ectod√©rmico. Su funci√≥n en la cresta epid√©rmica apical es indispensable para la correcta formaci√≥n de las extremidades, incluyendo la piel y sus ap√©ndices como las u√±as."
                },
                {
                    section: "Embriolog√≠a",
                    question: "En un estudio sobre el desarrollo fetal, se observa que alrededor de la semana 17 la u√±a ya cubre la mayor parte del lecho. ¬øQu√© evento clave ocurri√≥ aproximadamente en la semana 14 para permitir este crecimiento?",
                    options: [
                        "A) La formaci√≥n del esbozo de la l√°mina ungueal.",
                        "B) La constituci√≥n definitiva de la matriz ungueal.",
                        "C) La emergencia de la l√°mina ungueal desde debajo del pliegue proximal.",
                        "D) La queratinizaci√≥n completa del hiponiquio."
                    ],
                    answer: "C) La emergencia de la l√°mina ungueal desde debajo del pliegue proximal.",
                    feedback: "La opci√≥n C es correcta. Siguiendo la cronolog√≠a del desarrollo, despu√©s de que la matriz se forma y comienza a producir la l√°mina, el evento clave es la emergencia visible de esta l√°mina, que luego crece distalmente para cubrir el lecho."
                },
                {
                    section: "Embriolog√≠a",
                    question: "Un investigador estudia la se√±alizaci√≥n molecular en el desarrollo ungueal. Observa que la v√≠a de Wnt7a es fundamental para el establecimiento del eje dorso-ventral del miembro. ¬øQu√© consecuencia directa tiene esta v√≠a en la formaci√≥n de la u√±a?",
                    options: [
                        "A) Determina el grosor final de la l√°mina ungueal.",
                        "B) Es necesaria para la formaci√≥n del lecho ungueal vascularizado.",
                        "C) Induce la formaci√≥n de la matriz ungueal en la cara dorsal del dedo.",
                        "D) Controla la apoptosis en el pulpejo para dar forma al dedo."
                    ],
                    answer: "C) Induce la formaci√≥n de la matriz ungueal en la cara dorsal del dedo.",
                    feedback: "La opci√≥n C es la correcta. La se√±alizaci√≥n de Wnt7a en el ectodermo dorsal es el 'interruptor' que le dice a esa regi√≥n del dedo que debe diferenciarse en estructuras dorsales, como la matriz ungueal, en lugar de en piel plantar."
                },
                {
                    section: "Anatom√≠a",
                    question: "Durante una matricectom√≠a por onicocriptosis, el cirujano debe asegurarse de eliminar por completo las extensiones laterales de la matriz para evitar la recurrencia. ¬øC√≥mo se denominan estas proyecciones y por qu√© es crucial su extirpaci√≥n?",
                    options: [
                        "A) L√∫nulas laterales; porque producen el color de la u√±a.",
                        "B) Cuernos de la matriz; porque son tejido germinal que produce los bordes de la u√±a.",
                        "C) Pliegues periungueales; porque anclan la u√±a al dedo.",
                        "D) Bandas onicod√©rmicas; porque sellan el espacio subungueal."
                    ],
                    answer: "B) Cuernos de la matriz; porque son tejido germinal que produce los bordes de la u√±a.",
                    feedback: "La opci√≥n B es la correcta. Los 'cuernos' son las partes m√°s laterales de la matriz productora de u√±a. Si se deja alg√∫n resto, seguir√° generando una esp√≠cula de u√±a que causar√° la recurrencia de la onicocriptosis."
                },
                {
                    section: "Anatom√≠a",
                    question: "Al realizar una biopsia de la matriz ungueal, se debe tener cuidado de no profundizar excesivamente para no da√±ar una estructura tendinosa importante que se inserta cerca de su base. ¬øA qu√© tend√≥n nos referimos?",
                    options: [
                        "A) Tend√≥n del flexor largo del hallux.",
                        "B) Tend√≥n del extensor largo de los dedos.",
                        "C) Tend√≥n del tibial anterior.",
                        "D) Tend√≥n de Aquiles."
                    ],
                    answer: "B) Tend√≥n del extensor largo de los dedos.",
                    feedback: "La opci√≥n B es la correcta. Las fibras del tend√≥n extensor se insertan en la falange distal, muy cerca de la base de la matriz ungueal. Una biopsia o cirug√≠a demasiado agresiva en esta zona podr√≠a lesionarlo."
                },
                {
                    section: "Anatom√≠a",
                    question: "Un paciente sufre un traumatismo por aplastamiento en el primer ortejo. Para evaluar la viabilidad del aparato ungueal, es crucial entender su irrigaci√≥n. ¬øCu√°l de las siguientes opciones describe correctamente la vascularizaci√≥n de la matriz y el lecho?",
                    options: [
                        "A) Una √∫nica arteria digital que se ramifica en el pulpejo.",
                        "B) Una arcada proximal para la matriz y una arcada distal para el lecho ungueal.",
                        "C) Irrigaci√≥n directa desde los vasos de la falange distal.",
                        "D) Un plexo venoso superficial sin un componente arterial definido."
                    ],
                    answer: "B) Una arcada proximal para la matriz y una arcada distal para el lecho ungueal.",
                    feedback: "La opci√≥n B describe correctamente la anatom√≠a vascular. Las arterias digitales forman dos arcadas anastom√≥ticas: una proximal que irriga la matriz (vital para el crecimiento) y una distal para el lecho y el hiponiquio."
                },
                {
                    section: "Anatom√≠a",
                    question: "Un paciente presenta una pigmentaci√≥n oscura (melanoniquia) en la u√±a. Para realizar una biopsia y determinar si hay atipia, se debe tomar muestra del tejido donde residen los melanocitos. ¬øEn qu√© estructura del aparato ungueal se encuentran principalmente estas c√©lulas?",
                    options: [
                        "A) En el eponiquio (cut√≠cula).",
                        "B) En el lecho ungueal, de forma difusa.",
                        "C) En la matriz ungueal.",
                        "D) En el hiponiquio."
                    ],
                    answer: "C) En la matriz ungueal.",
                    feedback: "La opci√≥n C es la correcta. La matriz es donde se encuentran los melanocitos que producen el pigmento (melanina) y lo transfieren a las c√©lulas de la u√±a (onicocitos) a medida que esta se forma. Por eso, una biopsia por melanoniquia debe incluir tejido matricial."
                },
                {
                    section: "Patolog√≠a Ungueal",
                    question: "Un paciente con psoriasis severa acude a consulta por presentar m√∫ltiples depresiones puntiformes en sus u√±as, similar a un 'dedal'. ¬øQu√© proceso fisiopatol√≥gico en la matriz ungueal explica la formaci√≥n de este 'pitting'?",
                    options: [
                        "A) Una inflamaci√≥n cr√≥nica que causa adelgazamiento general de la u√±a.",
                        "B) Focos de queratinizaci√≥n anormal (paraqueratosis) en la matriz proximal que se desprenden.",
                        "C) Ruptura de peque√±os capilares en el lecho, formando hemorragias.",
                        "D) Hiperproliferaci√≥n de la matriz que resulta en un engrosamiento irregular."
                    ],
                    answer: "B) Focos de queratinizaci√≥n anormal (paraqueratosis) en la matriz proximal que se desprenden.",
                    feedback: "La opci√≥n B es correcta. El pitting psori√°sico ocurre cuando peque√±os focos de c√©lulas en la matriz proximal queratinizan de forma defectuosa. Estas c√©lulas paraquerat√≥sicas no se compactan bien y se desprenden de la superficie de la u√±a a medida que crece, dejando las depresiones."
                },
                {
                    section: "Patolog√≠a Ungueal",
                    question: "Un paciente de 65 a√±os, fumador, presenta una onicolisis (separaci√≥n de la u√±a del lecho) en un solo dedo que no responde a tratamientos para hongos ni mejora con cuidados generales. La lesi√≥n progresa lentamente y presenta hiperqueratosis subungueal. ¬øQu√© patolog√≠a grave se debe sospechar?",
                    options: [
                        "A) Verruga subungueal.",
                        "B) Exostosis subungueal.",
                        "C) Carcinoma escamoso subungueal.",
                        "D) Psoriasis ungueal localizada."
                    ],
                    answer: "C) Carcinoma escamoso subungueal.",
                    feedback: "La opci√≥n C es correcta. Una onicolisis cr√≥nica, unilateral y que no responde a tratamientos convencionales, especialmente en un paciente mayor con factores de riesgo, debe hacer levantar una alta sospecha de carcinoma escamoso subungueal."
                },
                {
                    section: "Patolog√≠a Ungueal",
                    question: "Una paciente presenta una banda roja longitudinal (eritroniquia) en el segundo dedo, con una fisura distal en 'V' e hiperqueratosis. La dermatoscopia no muestra vasos at√≠picos. ¬øCu√°l es el tumor benigno m√°s frecuentemente asociado a esta tr√≠ada cl√≠nica?",
                    options: [
                        "A) Tumor gl√≥mico.",
                        "B) Onicopapiloma.",
                        "C) Fibroqueratoma.",
                        "D) Quiste mixoide."
                    ],
                    answer: "B) Onicopapiloma.",
                    feedback: "La opci√≥n B es la correcta. La combinaci√≥n de eritroniquia, fisura distal e hiperqueratosis subungueal es altamente espec√≠fica para el onicopapiloma, un tumor benigno del epitelio de la matriz distal y el lecho ungueal."
                },
                {
                    section: "Patolog√≠a Ungueal",
                    question: "Un paciente llega a urgencias tras un traumatismo severo en el dedo, presentando un desprendimiento completo de la l√°mina ungueal desde su base (onicomadesis). ¬øQu√© grado de afectaci√≥n de la matriz implica este signo cl√≠nico?",
                    options: [
                        "A) Una afectaci√≥n leve y transitoria de la matriz proximal.",
                        "B) Una injuria severa que caus√≥ una detenci√≥n completa y temporal de la funci√≥n de toda la matriz.",
                        "C) Un da√±o exclusivo del lecho ungueal, sin compromiso de la matriz.",
                        "D) Una alteraci√≥n cr√≥nica de la matriz distal."
                    ],
                    answer: "B) Una injuria severa que caus√≥ una detenci√≥n completa y temporal de la funci√≥n de toda la matriz.",
                    feedback: "La opci√≥n B es la correcta. La onicomadesis es la expresi√≥n m√°xima de una detenci√≥n de la actividad matricial. La injuria (traum√°tica, infecciosa, sist√©mica) fue lo suficientemente severa como para que la matriz dejara de producir u√±a por completo, causando una fractura transversal en toda la l√°mina."
                },
                {
                    section: "Patolog√≠a Ungueal",
                    question: "Un paciente de fototipo II (piel clara) presenta una √∫nica banda de pigmento oscuro, de 4 mm de ancho, en el hallux, con variaci√≥n de color y pigmentaci√≥n del pliegue proximal (signo de Hutchinson). ¬øCu√°l es el diagn√≥stico m√°s probable y la acci√≥n a seguir?",
                    options: [
                        "A) Hematoma subungueal; observar evoluci√≥n.",
                        "B) Nevo de la uni√≥n; control fotogr√°fico anual.",
                        "C) Melanoma subungueal; requiere biopsia urgente.",
                        "D) Activaci√≥n melanoc√≠tica benigna; tranquilizar al paciente."
                    ],
                    answer: "C) Melanoma subungueal; requiere biopsia urgente.",
                    feedback: "La opci√≥n C es la correcta. La presencia de una banda pigmentada √∫nica, ancha, con varios colores y, sobre todo, el signo de Hutchinson en un paciente de piel clara, son todos signos de alta sospecha de melanoma. La biopsia de la matriz es mandatoria."
                },
                {
                    section: "Patolog√≠a Ungueal",
                    question: "Una madre te consulta por las 'manchitas blancas' en las u√±as de su hijo, preocupada por una deficiencia de calcio. ¬øCu√°l es la explicaci√≥n fisiopatol√≥gica correcta para esta leuconiquia punctata?",
                    options: [
                        "A) Son burbujas de aire atrapadas en la l√°mina.",
                        "B) Es un signo de deficiencia de zinc.",
                        "C) Son focos de queratinizaci√≥n defectuosa (paraqueratosis) en la matriz por microtraumas.",
                        "D) Indican una infecci√≥n f√∫ngica superficial."
                    ],
                    answer: "C) Son focos de queratinizaci√≥n defectuosa (paraqueratosis) en la matriz por microtraumas.",
                    feedback: "La opci√≥n C es la m√°s precisa. La leuconiquia punctata no se debe a falta de calcio ni a burbujas de aire (mitos comunes). Se produce por microtraumatismos en la matriz que alteran la queratinizaci√≥n, dejando c√©lulas con n√∫cleo (paraquerat√≥sicas) que se ven blancas."
                },
                {
                    section: "T√©cnicas Anest√©sicas",
                    question: "Vas a realizar una matricectom√≠a en el hallux. Para asegurar una anestesia completa con un bloqueo digital proximal, recuerdas que los nervios en este dedo tienen una disposici√≥n m√°s plantar. ¬øQu√© maniobra es indispensable en tu t√©cnica?",
                    options: [
                        "A) Usar un mayor volumen de anest√©sico que en otros dedos.",
                        "B) Inyectar solo en el dorso para evitar la arteria plantar.",
                        "C) Infiltrar profundo hasta la cara plantar y luego bloquear las ramas dorsales bajo el tend√≥n extensor.",
                        "D) Realizar la punci√≥n a nivel de la articulaci√≥n interfal√°ngica."
                    ],
                    answer: "C) Infiltrar profundo hasta la cara plantar y luego bloquear las ramas dorsales bajo el tend√≥n extensor.",
                    feedback: "La opci√≥n C describe la t√©cnica correcta. Es crucial asegurar que el anest√©sico llegue a la cara plantar y luego bloquear las ramas dorsales para lograr una anestesia completa y exitosa del hallux."
                },
                {
                    section: "T√©cnicas Anest√©sicas",
                    question: "Un ni√±o llega a urgencias con un hematoma subungueal a tensi√≥n muy doloroso que requiere drenaje inmediato. Para minimizar el dolor y el tiempo, ¬øcu√°l es la t√©cnica anest√©sica de elecci√≥n por su rapidez de acci√≥n?",
                    options: [
                        "A) Bloqueo del nervio tibial posterior.",
                        "B) Bloqueo digital proximal.",
                        "C) Bloqueo digital distal (infiltraci√≥n de los pliegues periungueales).",
                        "D) Anestesia t√≥pica con cloruro de etilo."
                    ],
                    answer: "C) Bloqueo digital distal (infiltraci√≥n de los pliegues periungueales).",
                    feedback: "La opci√≥n C es la ideal. El bloqueo distal act√∫a sobre las terminaciones nerviosas de forma casi instant√°nea, proporcionando una anestesia r√°pida y efectiva para procedimientos urgentes y localizados en la u√±a."
                },
                {
                    section: "T√©cnicas Anest√©sicas",
                    question: "Est√°s realizando una biopsia de matriz y realizas una inyecci√≥n submatricial. Inyectas lentamente el anest√©sico y observas que la zona de la l√∫nula se vuelve p√°lida. ¬øQu√© significa este signo cl√≠nico?",
                    options: [
                        "A) Que has inyectado en la articulaci√≥n.",
                        "B) Que la infiltraci√≥n es correcta, ya que el l√≠quido comprime los capilares.",
                        "C) Que est√°s causando una reacci√≥n al√©rgica local.",
                        "D) Que has puncionado la falange distal."
                    ],
                    answer: "B) Que la infiltraci√≥n es correcta, ya que el l√≠quido comprime los capilares.",
                    feedback: "La opci√≥n B es la correcta. La palidez isqu√©mica en la l√∫nula es el signo visual de que el anest√©sico est√° en el plano correcto, entre la matriz y el hueso, asegurando una anestesia efectiva para el procedimiento."
                },
                {
                    section: "T√©cnicas Anest√©sicas",
                    question: "Un paciente requiere el desbridamiento de lesiones ulcerosas en la cara plantar de los cinco dedos del pie. Para maximizar la comodidad del paciente y la eficiencia del procedimiento, ¬øqu√© bloqueo nervioso √∫nico ser√≠a el m√°s apropiado?",
                    options: [
                        "A) Bloqueo del nervio safeno.",
                        "B) Cinco bloqueos digitales proximales individuales.",
                        "C) Bloqueo del nervio tibial posterior a nivel del tobillo.",
                        "D) Bloqueo del nervio peroneo superficial."
                    ],
                    answer: "C) Bloqueo del nervio tibial posterior a nivel del tobillo.",
                    feedback: "La opci√≥n C es la m√°s eficiente. El nervio tibial posterior inerva la mayor parte de la planta del pie. Un solo bloqueo en el t√∫nel del tarso puede anestesiar toda la zona, evitando m√∫ltiples y dolorosas inyecciones."
                },
                {
                    section: "T√©cnicas Anest√©sicas",
                    question: "Durante un bloqueo digital, aspiras antes de inyectar y obtienes sangre en la jeringa, indicando una punci√≥n intravascular. Adem√°s del hematoma, ¬øcu√°l es el riesgo sist√©mico m√°s grave si inyectaras el anest√©sico?",
                    options: [
                        "A) Necrosis del dedo.",
                        "B) Una infecci√≥n severa.",
                        "C) Toxicidad cardiovascular o del sistema nervioso central.",
                        "D) Falla del bloqueo anest√©sico."
                    ],
                    answer: "C) Toxicidad cardiovascular o del sistema nervioso central.",
                    feedback: "La opci√≥n C es correcta. La inyecci√≥n intravascular de un anest√©sico local puede causar toxicidad sist√©mica, con efectos graves como arritmias card√≠acas o convulsiones. Por eso la aspiraci√≥n es un paso de seguridad fundamental."
                },
                {
                    section: "T√©cnicas Anest√©sicas",
                    question: "Te preparas para una matricectom√≠a qu√≠mica con fenol en un paciente con onicocriptosis. Despu√©s de la avulsi√≥n parcial y la ex√©resis del tejido de granulaci√≥n, aplicas un torniquete y esperas a que el campo est√© exang√ºe. ¬øPor qu√© es este paso tan crucial para el √©xito del procedimiento?",
                    options: [
                        "A) Para disminuir la inflamaci√≥n postoperatoria.",
                        "B) Para prevenir que la sangre inactive el fenol, lo que causar√≠a un fallo en la cauterizaci√≥n.",
                        "C) Para asegurar que el anest√©sico local siga haciendo efecto.",
                        "D) Para reducir el riesgo de infecci√≥n post-quir√∫rgica."
                    ],
                    answer: "B) Para prevenir que la sangre inactive el fenol, lo que causar√≠a un fallo en la cauterizaci√≥n.",
                    feedback: "La opci√≥n B es la correcta. El fenol act√∫a coagulando las prote√≠nas del tejido. La sangre es rica en prote√≠nas, y si est√° presente, neutralizar√° el fenol antes de que pueda destruir eficazmente la matriz, llevando a una alta probabilidad de recurrencia."
                }
            ]
        };

        // --- FUNCIONES PARA CASO DE ESTUDIO CON GEMINI ---
        
        // --- CAMBIO 1: Variable para guardar las respuestas ---
        let hiddenAnswers = '';
        
        const GEMINI_API_KEY = "AIzaSyCdkq5Bjzp4fpyMndVKp2CZx5Be_WkEv5I"; // API key de Gemini

        async function callGroundedGemini(prompt, systemPrompt) {
            const model = "gemini-2.5-pro"; // Modelo m√°s reciente y potente - Gemini 2.5 Pro
            if (!GEMINI_API_KEY) {
                return {
                    text: "Error: La clave de la API de Gemini no ha sido configurada. Por favor, a√±√°dela en la variable 'GEMINI_API_KEY' dentro del c√≥digo.",
                    sources: []
                };
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
            };

            if (systemPrompt) {
                payload.systemInstruction = { parts: [{ text: systemPrompt }] };
            }

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate?.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    const groundingMetadata = candidate.groundingMetadata;
                    const sources = (groundingMetadata?.groundingAttributions || []).map(attr => ({
                        uri: attr.web?.uri,
                        title: attr.web?.title
                    })).filter(s => s.uri && s.title);
                    return { text, sources };
                } else {
                    console.warn("API response structure might have changed or was empty:", result);
                    let errorMessage = "No se recibi√≥ una respuesta v√°lida de la API.";
                    if (candidate && candidate.finishReason === 'SAFETY') {
                        errorMessage = "La respuesta fue bloqueada por pol√≠ticas de seguridad. Intenta reformular la solicitud.";
                    }
                    return { text: errorMessage, sources: [] };
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return {
                    text: "Lo siento, no se pudo generar la respuesta en este momento. Por favor, revisa la consola para m√°s detalles.",
                    sources: []
                };
            }
        }

        async function generateCaseStudy() {
            const button = document.getElementById('gemini-case-study-button');
            const spinner = document.getElementById('case-study-spinner');
            const textEl = document.getElementById('case-study-text');
            const sourcesEl = document.getElementById('case-study-sources');
            const answersContainer = document.getElementById('case-study-answers-container');
            const answersContent = document.getElementById('case-study-answers-content');

            button.disabled = true;
            spinner.classList.remove('hidden');
            textEl.textContent = '';
            sourcesEl.innerHTML = '';
            answersContainer.classList.add('hidden'); 
            answersContent.classList.add('hidden');
            hiddenAnswers = ''; // Limpiar respuestas anteriores

            // Determinar si hay errores o si es 100%
            const incorrectTopics = new Set();
            const allTopics = new Set();
            
            examen.userAnswers.forEach((answer, index) => {
                const question = examen.config.questions[index];
                allTopics.add(question.section);
                
                if (question.options[answer] !== question.answer) {
                    incorrectTopics.add(question.section);
                }
            });

            let topics, userPrompt;
            
            if (incorrectTopics.size > 0) {
                // Hay errores: caso personalizado basado en temas fallidos
                topics = Array.from(incorrectTopics).join(', ');
                userPrompt = `Temas a reforzar: ${topics}. Por favor, genera el caso de estudio.`;
            } else {
                // Es 100%: caso cl√≠nico de tema aleatorio
                const randomTopics = Array.from(allTopics);
                const randomTopic = randomTopics[Math.floor(Math.random() * randomTopics.length)];
                topics = randomTopic;
                userPrompt = `El estudiante obtuvo 100% en el examen. Genera un caso cl√≠nico avanzado sobre: ${randomTopic}. Debe ser m√°s desafiante que las preguntas del examen.`;
            }

            // --- CAMBIO 2: Modificaci√≥n del System Prompt ---
            const systemPrompt = `Eres un profesor experto en podiatr√≠a creando un caso cl√≠nico para un estudiante. Basado en los siguientes temas, crea un caso pr√°ctico y conciso (150-200 palabras) que presente un escenario de un paciente realista. 

Basate espec√≠ficamente en estas fuentes acad√©micas de podiatr√≠a:

LIBROS DE TEXTO CL√ÅSICOS:
- McGlamry's Comprehensive Textbook of Foot and Ankle Surgery
- The Foot and Ankle: A Core Curriculum (Coughlin, Mann, Saltzman)
- Surgery of the Foot and Ankle (Coughlin, Mann, Saltzman)
- Podiatric Medicine and Surgery (Banks, Downey, Martin)
- Nail Surgery (Nail Surgery Atlas - Haneke)
- Dermatology - Bolognia (secciones de u√±as)

REVISTAS ACAD√âMICAS:
- Journal of the American Podiatric Medical Association (JAPMA)
- Foot & Ankle International
- Journal of Foot and Ankle Surgery
- Dermatologic Surgery (secciones de cirug√≠a ungueal)
- International Journal of Dermatology
- Journal of the European Academy of Dermatology and Venereology

Finaliza con 1-2 preguntas desafiantes para que el estudiante reflexione sobre diagn√≥stico diferencial, t√©cnica quir√∫rgica, o manejo postoperatorio.

IMPORTANTE: Las preguntas deben empezar con "Pregunta 1:" y "Pregunta 2:" para que sean detectadas correctamente por el sistema.

Despu√©s de las preguntas, incluye un separador bien definido como '---RESPUESTAS---'.

Finalmente, debajo del separador, escribe las respuestas detalladas y el razonamiento cl√≠nico para cada una de las preguntas que planteaste.

Despu√©s de las respuestas, incluye otro separador como '---FUENTES---' y lista las fuentes acad√©micas espec√≠ficas que utilizaste para fundamentar el caso cl√≠nico y las respuestas, incluyendo:
- Libros de texto relevantes
- Art√≠culos cient√≠ficos espec√≠ficos
- Gu√≠as cl√≠nicas actualizadas
- Protocolos de tratamiento reconocidos

Formato las fuentes como una lista numerada con el formato: "1. Autor(es). T√≠tulo del libro/art√≠culo. Editorial/Revista. A√±o."`;

            // --- CAMBIO 3: L√≥gica para procesar la respuesta √∫nica ---
            const result = await callGroundedGemini(userPrompt, systemPrompt);
            
            const fullText = result.text;
            const separator = '---RESPUESTAS---';
            let caseText = fullText;
            
            console.log('Full API response:', fullText);
            console.log('Looking for separator:', separator);
            
            // Separar el caso de las respuestas
            if (fullText.includes(separator)) {
                const parts = fullText.split(separator);
                caseText = parts[0];      // Parte visible: El caso y las preguntas
                hiddenAnswers = parts[1] || "No se generaron respuestas."; // Parte oculta: Las respuestas
                console.log('Separator found! Case text length:', caseText.length);
                console.log('Hidden answers length:', hiddenAnswers.length);
            } else {
                // Fallback por si la API no sigue la instrucci√≥n
                caseText = fullText;
                hiddenAnswers = "No se encontraron respuestas separadas. La API podr√≠a no haber seguido la instrucci√≥n del separador.";
                console.log('Separator NOT found. Using fallback.');
            }
            
            // Mostrar el caso cl√≠nico, preguntas Y respuestas juntos
            const combinedText = caseText + '\n\n' + '---RESPUESTAS---\n\n' + hiddenAnswers;
            textEl.innerHTML = this.formatTextWithMarkdown(combinedText);
            
            // Mostrar fuentes
            if (result.sources && result.sources.length > 0) {
                let sourcesHtml = '<h4 class="titulo-fuentes">Fuentes Consultadas:</h4><ul class="lista-fuentes">';
                result.sources.forEach(source => {
                    sourcesHtml += `<li><a href="${source.uri}" target="_blank">${source.title}</a></li>`;
                });
                sourcesHtml += '</ul>';
                sourcesEl.innerHTML = sourcesHtml;
            }

            spinner.classList.add('hidden');
            
            // Ocultar el contenedor del bot√≥n ya que mostramos respuestas directamente
            answersContainer.classList.add('hidden');
        }

        // --- FUNCI√ìN PARA FORMATEAR TEXTO CON MARKDOWN ---
        function formatTextWithMarkdown(text) {
            return text
                // Convertir **texto** a <strong>texto</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convertir *texto* a <em>texto</em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Convertir saltos de l√≠nea dobles a p√°rrafos
                .replace(/\n\n/g, '</p><p>')
                // Convertir saltos de l√≠nea simples a <br>
                .replace(/\n/g, '<br>')
                // Envolver en p√°rrafo inicial
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                // Limpiar p√°rrafos vac√≠os
                .replace(/<p><\/p>/g, '')
                // Formatear preguntas
                .replace(/(Pregunta \d+:)/g, '<h4 class="pregunta-caso">$1</h4>')
                // Formatear respuestas
                .replace(/(Respuesta \d+:)/g, '<h4 class="respuesta-caso">$1</h4>')
                // Formatear separador de respuestas
                .replace(/---RESPUESTAS---/g, '<hr class="separador-respuestas">')
                // Formatear separador de fuentes
                .replace(/---FUENTES---/g, '<hr class="separador-fuentes"><h4 class="titulo-fuentes">üìö Fuentes Acad√©micas:</h4>')
                // Formatear listas con vi√±etas
                .replace(/^(\d+\.\s)/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        }

        // --- CAMBIO 4: Funci√≥n 'reveal' simplificada ---
        // Ya no es 'async' porque no llama a la API
        function revealCaseStudyAnswers() {
            const button = document.getElementById('gemini-reveal-answers-button');
            const answersContent = document.getElementById('case-study-answers-content');
            const spinner = document.getElementById('case-study-answers-spinner');
            const textEl = document.getElementById('case-study-answers-text');

            console.log('Revealing answers...');
            console.log('hiddenAnswers content:', hiddenAnswers);

            button.disabled = true; // Deshabilitar despu√©s del primer clic
            answersContent.classList.remove('hidden'); // Mostrar contenedor de respuestas
            spinner.classList.add('hidden'); // Asegurarse que el spinner no se vea

            // Verificar que tenemos respuestas
            if (hiddenAnswers && hiddenAnswers.trim() !== '') {
                textEl.textContent = hiddenAnswers;
                console.log('Answers displayed successfully');
            } else {
                textEl.textContent = 'No se encontraron respuestas. Por favor, regenera el caso de estudio.';
                console.log('No answers found');
            }
            
            // Asegurar que el contenedor de respuestas sea visible
            answersContent.style.display = 'block';
        }
    </script>
</body>
</html>
